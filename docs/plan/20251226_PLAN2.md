# プランニングドキュメント：メモのサムネイル（WebP）機能

**作成日**: 2025-12-26  
**バージョン**: 1.0  
**ステータス**: 実装完了（DB反映待ち）

---

## クイックリファレンス

**目的**
- 画像プロンプトのメモにサムネイルを付け、内容のイメージを素早く確認できるようにする
- 省データを優先し、WebPの軽量サムネで保存する

**対象**
- パネルUI（メモ入力欄の貼り付け/ドラッグ&ドロップ）
- Supabase Storage へのサムネ保存
- メモデータ/同期（thumbnailPath）
- Supabase 変更は supabase CLI 経由（migration + db push）

**非対象（今回やらない）**
- 下書きタブでのサムネ設定
- 画像の本文埋め込み（本文中へのインライン画像表示）
- 画像編集ツール（トリミングや回転など）

**完了条件（要点）**
1. メモ入力欄への貼り付け/ドラッグ&ドロップでサムネ設定できる（下書きタブは不可）
2. 画像は「縦横比維持 + 解像度1/2 + WebP変換」で保存される
3. サムネ設定時に既存サムネがある場合は確認ポップアップが出て、上書き時に旧サムネを削除する（Supabaseからも削除）
4. タブを右クリックするとサムネ表示＋削除ボタンが出る。削除でSupabaseからも消える

---

## 1. 変更したいUX（ユーザー要望）

### 1.1 サムネ設定
- メモ入力欄に画像を貼り付け、またはドラッグ&ドロップでサムネ設定
- 既存サムネがある場合は確認を挟み、許可時に上書き・旧削除

### 1.2 サムネ表示/削除
- タブを右クリックするとサムネが表示される
- 同時に削除ボタンを表示し、削除でSupabaseからも消える

### 1.3 画像変換
- 元画像を縦横比保持で1/2解像度にリサイズ
- WebPへ変換して軽量化し、Supabase Storageへ保存

---

## 2. 現状構成（関係ファイル）

- `src/content/content.ts`: パネルUIイベント、メモ入力欄のイベント
- `src/content/panelView.ts`: タブ描画
- `src/content/panelTemplate.ts`: UI構造
- `src/utils/storage.ts`: ノートデータの保存/更新
- `src/lib/sync.ts`: Supabase同期
- `src/lib/supabase.ts`: Supabaseクライアント
- `src/types/index.ts`: データモデル
- `supabase_setup.sql`: DBスキーマ

---

## 3. 実装方針（案）

### 3.1 データモデル
- `Note` / `NoteMetadata` に `thumbnailPath?: string` を追加
- Supabase `memos` テーブルに `thumbnail_path` を追加
- 同期処理（upload/download）で `thumbnail_path` を反映

### 3.2 Storage
- Supabase Storage のバケットを用意し、サムネの WebP を保存
- 保存パスは `userId/noteId.webp` のように一意化
- 既存サムネの削除は Storage からも削除

### 3.3 画像変換
- `canvas` で縦横比維持の1/2リサイズ
- `canvas.toBlob('image/webp', quality)` で WebP 変換
- `quality` は固定値（要確定）

### 3.4 UI/UX
- メモ入力欄の `paste` と `drop` で画像を受け取る
- 下書きタブでは拒否（通知）
- 既存サムネがある場合、確認ダイアログで上書き許可
- タブ右クリックでサムネ表示 + 削除ボタン（コンテキストUI）

---

## 4. タスク分解

### Phase 0: 仕様確定（短時間）
- [x] Storageバケットは **署名URL（signed URL）** を使用
- [x] WebPの quality 値は **0.7** 固定
- [x] タブ右クリックのサムネ表示UI仕様（サイズ/レイアウト）を確定

### Phase 1: データ/同期拡張
- [x] `src/types/index.ts` に `thumbnailPath` を追加
- [x] `supabase_setup.sql` に `thumbnail_path` を追加
- [x] `src/utils/storage.ts` の保存/更新を対応
- [x] `src/lib/sync.ts` の upload/download に反映
- [ ] **DBへ反映**: `supabase db push`（※Storage権限のためDBパスワード指定が必要）

### Phase 2: Storage操作
- [x] WebPアップロード処理の追加
- [x] 削除処理の追加（上書き/削除時）

### Phase 3: UI/入力対応
- [x] メモ入力欄の `paste` / `drop` を実装
- [x] 下書きタブでは拒否するガードを追加
- [x] 既存サムネがある場合の確認ダイアログを実装

### Phase 4: タブ右クリックUI
- [x] サムネ表示 + 削除ボタンのUIを追加
- [x] 削除でStorage + DBの反映
- [x] サムネ表示が出ない問題の修正（`display: none !important` を解除）
- [x] サムネデータ転送の不整合を修正（base64で送信し背景側で復元）
- [x] サムネ画像クリックで2倍拡大（トグル表示）

### Phase 4.1: AIモーダルUX
- [x] AI実行中のローディングアニメーションを追加
- [x] AI反映完了でモーダルを自動クローズ
- [x] AIモーダル下部に選択状態（全文選択 / 一部選択 / カーソル挿入）を表示

### Phase 5: ドキュメント同期
- [ ] `docs/requirement/requirement.md` の更新
- [ ] README/INSTALL に影響があれば更新

---

## 5. 手動確認チェックリスト（完了判定）

- [ ] 保存済みメモで画像貼り付け/ドロップ→サムネが設定される
- [ ] 下書きタブではサムネ設定できない
- [ ] 既存サムネありで新規設定→確認後に上書きされる
- [ ] タブ右クリックでサムネ表示 + 削除ボタンが出る
- [ ] 削除後、Supabase上からも消える
- [ ] `supabase db push` が成功する（StorageのPolicy含む）

---

## メモ: DB反映手順（ローカルから）

- Storage（`storage.objects`）へのRLS/Policy作成は権限が必要なため、`supabase db push` 実行時にDBパスワード指定が必要
  - 例: `supabase db push --yes -p <DB_PASSWORD>`
