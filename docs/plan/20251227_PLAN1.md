# プランニングドキュメント：YouTube動画のトランスクリプト取得 → 日本語要約 → クイックメモ反映

## 共通ルール（必読）

- 共通ルールはリポジトリルートの `AGENTS.md` を参照: `../../AGENTS.md`

## 今回の追加ルール / 例外（差分だけを書く）

- 追加ルール: YouTubeのDOMは変化しやすいので、セレクタ依存を最小化し、`MutationObserver` + 重複注入防止（data属性）で安全に実装する
- 例外: 本セッションはエクスポート/同期の不具合修正を優先（YouTube計画は一時中断）

## 実装モード（単独 / 並列）

- 実装モード: 単独
- 判定理由（要点だけ）:
  - 分割の独立性（契約で切れる）: NG（content script / UI / storage をまたぐ）
  - 合流コスト（共有境界の多さ）: 高
  - 編集衝突（同じファイル/意思決定の奪い合い）: 高

**作成日**: 2025-12-27  
**バージョン**: 0.1  
**ステータス**: ドラフト  
**前バージョンからの変更**: 新規作成

---

# 進捗状況

## ⚡ クイックリファレンス

**現在地**: Phase 0 - 一時中断（エクスポート/同期の不具合修正対応）  
**次のアクション**: エクスポート/同期の不具合修正 → 確認 → YouTube計画の再開判断  
**ブロッカー**: なし  
**重要な決定事項**: 既存の `Gemini` 呼び出し（`MessageType.GEMINI_GENERATE`）を要約エンジンとして再利用（新規バックエンドなし）  
**重要な決定事項**: 同期ボタンを「リモート→ローカル」「ローカル→リモート」に分割し、実行前に警告を表示（自動同期は行わない）  
**重要な決定事項**: エクスポート時にサムネ取得が失敗した場合はスキップして続行する
**重要な決定事項**: メモ一覧にコピーアイコンを追加し、ヘッダー左のコピーアイコンで「今開いているメモ」をコピーする
**重要な決定事項**: `noteMetadata` は `chrome.storage.local` に移し、`chrome.storage.sync` の容量制限を回避する
**重要な決定事項**: コピー時に `copied` を表示してフェードアウトする

## 確認事項（最大3つ）

1) クイックメモへの反映は「上書き」か「末尾に追記」どちらにしますか？（動画タイトル/URLも入れますか？） →上書き
2) 字幕が取得できない動画（字幕なし/取得失敗）の挙動はどうしますか？（例: エラー表示のみ / 何もしない / watchページを開く）  →エラー表示のみ
3) `docs/requirement/requirements.md` を新規作成して、既存 `docs/requirement/requirement.md` を移行しますか？  →修正済

---

# 要件概要

## 背景・目的

- YouTubeの動画一覧ページ上で、動画ごとに「要約してクイックメモに残す」を最短操作で行えるようにする。

## 実装する機能（今回）

- YouTubeの複数動画が並ぶページで、各動画サムネ右上に本拡張のアイコンボタンをオーバーレイ表示
- ボタン押下で対象動画のトランスクリプト（字幕）を取得
- 取得した字幕を日本語で要約し、クイックメモ（下書きメモ）に反映
- 要約プロンプトをユーザーが設定できる
- AIチャット用プロンプト設定／AI要約用プロンプト設定を「同期 / サインイン（👤）」モーダルへ移動する

## スコープ外（今回しない）

- YouTube以外のサイト対応
- 動画音声からの書き起こし（字幕が無い動画を文字起こしして生成する）
- 要約結果の自動フォルダ保存（手動保存は既存機能の範囲）

---

# アーキテクチャ設計（案）

## 主要な変更箇所（予定）

- `src/content/content.ts`: YouTube DOM監視、オーバーレイ注入、クリック処理、進捗表示、クイックメモ更新
- `src/content/panelTemplate.ts`: 認証モーダルにプロンプト設定UIを追加、AIモーダルから設定UIを削除/移動
- `src/styles/panel.css`: YouTubeオーバーレイ用の最小CSS（衝突しない接頭辞）

※肥大化する場合は `src/content/youtube/*.ts` へ分離（当初は最小差分で開始）

## データフロー（クリック時）

1. Content Script: videoId抽出 → watchページHTMLを取得
2. Content Script: captionTracks抽出 → 字幕データ取得 → プレーンテキスト化
3. Content Script → Background: `MessageType.GEMINI_GENERATE` で要約（Gemini APIキー必須）
4. Content Script → Background: `MessageType.UPDATE_QUICK_MEMO` で反映
5. パネルが開いている場合はUIに即反映（閉じている場合は次回表示時に反映）

---

# 実装フェーズ（案）

## Phase 0: 仕様確定

- [ ] 確認事項3点を確定
- [ ] 既存要件ドキュメントの置き場を確定（`requirements.md` 作成 여부）

## Phase 1: YouTubeオーバーレイ表示

- [ ] YouTubeページ判定（`youtube.com` を対象、`m.youtube.com` は対象外などを決める）
- [ ] 動画カード検出（`MutationObserver`）＋重複防止
- [ ] ボタンUI（hover / loading / error）の最小実装

## Phase 2: トランスクリプト取得

- [ ] videoId抽出（最小: `/watch?v=...`）
- [ ] watchページから captionTracks を抽出
- [ ] 字幕データ取得（`fmt=json3` 等）→テキスト化
- [ ] 字幕なし/取得失敗のハンドリング

## Phase 3: 要約 → クイックメモ反映

- [ ] 要約プロンプト（デフォルト + ユーザー設定）を組み立て
- [ ] Gemini呼び出し（既存 `MessageType.GEMINI_GENERATE` を利用）
- [ ] クイックメモ更新（追記 or 上書き）
- [ ] クリック連打/並列実行のガード（動画単位のロック）

## Phase 4: プロンプト設定UIの移動

- [ ] `👤` モーダルに「AIチャット」「AI要約」プロンプト欄を追加
- [ ] AIモーダルからプロンプト設定UIを削除（または非表示）
- [ ] 既存保存キー（`geminiCustomPrompt` 等）の互換性確認（破壊的変更を避ける）

## Phase 5: 動作確認

- [ ] 対象ページ: TOP / 検索 / チャンネル / 動画一覧（SPA遷移含む）
- [ ] 例外: 字幕なし、年齢制限、地域制限、ログイン必要動画
- [ ] パフォーマンス: スクロール時の負荷、メモパネルへの影響

---

# リスクと対応策

- YouTube DOM変更でボタンが付かない: セレクタを最小化し、失敗時は無害にスキップする
- 字幕取得の仕様変更/取得不可: エラー表示（最小は `alert`）と再試行手段を用意する
- 字幕が長くGeminiが失敗: 文字数上限や分割を検討（必要になってから段階導入）

---

# 完了条件（OKライン）

- YouTubeの複数動画が並ぶ主要ページで、各動画にオーバーレイボタンが表示される
- ボタン押下で（字幕がある動画は）日本語要約が生成され、クイックメモへ反映される
- AIチャット/AI要約のプロンプト設定が「👤」モーダルで編集でき、保存される
- 字幕なし等の失敗時に、ユーザーが状況を理解できるエラーが出る
