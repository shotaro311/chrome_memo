# プランニングドキュメント：YouTube動画のトランスクリプト取得 → 日本語要約 → クイックメモ反映

## 共通ルール（必読）

- 共通ルールはリポジトリルートの `AGENTS.md` を参照: `../../AGENTS.md`

## 今回の追加ルール / 例外（差分だけを書く）

- 追加ルール: YouTubeのDOMは変化しやすいので、セレクタ依存を最小化し、`MutationObserver` + 重複注入防止（data属性）で安全に実装する
- 追加ルール: 字幕取得は既存アプリの方式（`captionTracks` → `baseUrl` のXML取得 → `<text start="...">` パース）を踏襲し、拡張の背景（service worker）側でfetch/パースする
- 例外: なし

## 実装モード（単独 / 並列）

- 実装モード: 単独
- 判定理由（要点だけ）:
  - 分割の独立性（契約で切れる）: NG（content script / UI / storage をまたぐ）
  - 合流コスト（共有境界の多さ）: 高
  - 編集衝突（同じファイル/意思決定の奪い合い）: 高

**作成日**: 2025-12-28  
**バージョン**: 0.3  
**ステータス**: 実装中  
**前バージョンからの変更**: Phase 1-4 実装反映
**承認**: 2025-12-28 by user

---

# 進捗状況

## ⚡ クイックリファレンス

**現在地**: Phase 2 - 字幕取得の不具合修正（字幕専用サーバー化 / 検証待ち）  
**次のアクション**: Render上の字幕APIを再デプロイして取得確認（成功/失敗ログの確認）  
**ブロッカー**: なし（結果待ち）  
**変更ファイル**: `src/background/background.ts`, `server/index.mjs`, `package.json`, `docs/requirement/requirements.md`  
**追加成果物**: `docs/report/20251228_youtube-transcript-fetch-empty.md`, `docs/report/20251228_youtube-summary-extension-research.md`  
**重要な決定事項**: 既存の `Gemini` 呼び出し（`MessageType.GEMINI_GENERATE`）を要約エンジンとして再利用（新規バックエンドなし）
**重要な決定事項**: 字幕取得は `docs/report/handoff_chrome_extension_transcript.md` の方式をベースに実装（`captionTracks` 優先言語選択 + XMLパース + タイムスタンプ整形）
**重要な決定事項**: timedtext取得は `fmt=json3 → fmt=srv3 → baseUrl` の順でフォールバックし、空データを回避
**重要な決定事項**: YouTube側の制限回避のため、`youtubei/v1/player` で `captionTracks` を再取得する方式を実装
**重要な決定事項**: `transcriptApiUrl` が設定されている場合は外部サーバーAPIを優先する
**重要な決定事項**: 外部サーバーは「字幕のみ」返すAPIとして構成する（コメント/メタデータは取得しない）
**重要な決定事項**: Render起動エラーの原因だった正規表現をRegExp文字列に置換
**重要な決定事項**: オーバーレイは `ytd-thumbnail` に注入し、左上ホバー表示にする（ホバー再生の差し替え影響を回避）

## 確認事項（最大3つ）

1) クイックメモへの反映: 上書き
2) 字幕が取得できない動画: エラー表示のみ
3) `docs/requirement/requirements.md`: 作成済み（旧 `docs/requirement/requirement.md` は削除）

---

# 要件概要

## 背景・目的

- YouTubeの動画一覧ページ上で、動画ごとに「要約してクイックメモに残す」を最短操作で行えるようにする。

## 実装する機能（今回）

- YouTubeの複数動画が並ぶページで、各動画サムネ右上に本拡張のアイコンボタンをオーバーレイ表示
- ボタン押下で対象動画のトランスクリプト（字幕）を取得
- 取得した字幕を日本語で要約し、クイックメモ（下書きメモ）に反映
- 要約プロンプトをユーザーが設定できる
- AIチャット用プロンプト設定／AI要約用プロンプト設定を「同期 / サインイン（👤）」モーダルへ移動する

## スコープ外（今回しない）

- YouTube以外のサイト対応
- 動画音声からの書き起こし（字幕が無い動画を文字起こしして生成する）
- 要約結果の自動フォルダ保存（手動保存は既存機能の範囲）

---

# アーキテクチャ設計（案）

## 主要な変更箇所（予定）

- `src/content/content.ts`: YouTube DOM監視、オーバーレイ注入、クリック処理、進捗表示、クイックメモ更新
- `src/content/panelTemplate.ts`: 認証モーダルにプロンプト設定UIを追加、AIモーダルから設定UIを削除/移動
- `src/styles/panel.css`: YouTubeオーバーレイ用の最小CSS（衝突しない接頭辞）

※肥大化する場合は `src/content/youtube/*.ts` へ分離（当初は最小差分で開始）

## データフロー（クリック時）

1. Content Script: videoId抽出（一覧ページの各動画カードから）
2. Content Script → Background: 字幕取得（`transcriptApiUrl` があればサーバーAPI優先。未設定/失敗時は拡張内取得へフォールバック）
3. Content Script → Background: `MessageType.GEMINI_GENERATE` で要約（Gemini APIキー必須）
4. Content Script → Background: `MessageType.UPDATE_QUICK_MEMO` で反映
5. パネルが開いている場合はUIに即反映（閉じている場合は次回表示時に反映）

---

# 実装フェーズ（案）

## Phase 0: 仕様確定

- [x] 確認事項3点を確定
- [x] 既存要件ドキュメントの置き場を確定（`requirements.md` 作成）

## Phase 1: YouTubeオーバーレイ表示

- [x] YouTubeページ判定（`youtube.com` 系を対象）
- [x] 動画カード検出（`MutationObserver`）＋重複防止
- [x] ボタンUI（hover / loading / error）の最小実装

## Phase 2: トランスクリプト取得

- [x] videoId抽出（最小: `/watch?v=...`）
- [x] watchページから captionTracks を抽出
- [x] 字幕データ取得（XML）→テキスト化
- [x] 字幕なし/取得失敗のハンドリング
- [ ] timedtext取得フォールバック強化の検証（fmt=json3 → fmt=srv3 → baseUrl）
- [ ] `youtubei/v1/player` 経由の取得検証（ytcfgキー使用）
- [ ] Render字幕API 経由の取得検証（`transcriptApiUrl` 設定）
- [ ] Renderデプロイ手順の共有（env設定含む）

## Phase 3: 要約 → クイックメモ反映

- [x] 要約プロンプト（デフォルト + ユーザー設定）を組み立て
- [x] Gemini呼び出し（既存 `MessageType.GEMINI_GENERATE` を利用）
- [x] クイックメモ更新（上書き）
- [x] クリック連打/並列実行のガード（動画単位のロック）

## Phase 4: プロンプト設定UIの移動

- [x] `👤` モーダルに「AIチャット」「AI要約」プロンプト欄を追加
- [x] AIモーダルからプロンプト設定UIを削除（または非表示）
- [x] 既存保存キー（`geminiCustomPrompt` 等）の互換性確認（破壊的変更を避ける）

## Phase 5: 動作確認

- [ ] 対象ページ: TOP / 検索 / チャンネル / 動画一覧（SPA遷移含む）
- [ ] 例外: 字幕なし、年齢制限、地域制限、ログイン必要動画
- [ ] パフォーマンス: スクロール時の負荷、メモパネルへの影響

---

# リスクと対応策

- YouTube DOM変更でボタンが付かない: セレクタを最小化し、失敗時は無害にスキップする
- 字幕取得の仕様変更/取得不可: エラー表示（最小は `alert`）と再試行手段を用意する
- 字幕が長くGeminiが失敗: 文字数上限や分割を検討（必要になってから段階導入）

---

# 完了条件（OKライン）

- YouTubeの複数動画が並ぶ主要ページで、各動画にオーバーレイボタンが表示される
- ボタン押下で（字幕がある動画は）日本語要約が生成され、クイックメモへ反映される
- AIチャット/AI要約のプロンプト設定が「👤」モーダルで編集でき、保存される
- 字幕なし等の失敗時に、ユーザーが状況を理解できるエラーが出る
