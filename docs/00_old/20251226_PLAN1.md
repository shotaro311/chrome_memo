# プランニングドキュメント：フォルダ管理（リネーム/削除/並び替え） + AI編集UX改善 + ヘッダー整理

**作成日**: 2025-12-26  
**バージョン**: 1.0  
**ステータス**: 実装完了（手動確認待ち）

---

## クイックリファレンス

**目的**
- フォルダの管理（名前変更/削除/並び替え）をUIから可能にする
- AIによる文章編集を「選択→指示→Enter」で素早く使えるUXにする
- メモ上部のアイコン配置を整理する

**対象**
- パネルUI（content script）
- フォルダ情報の保存形式（並び順を保持するため）

**非対象（今回やらない）**
- 同期の方式変更（Supabase等）や、大規模なデータ移行
- AIモデル切替やプロンプト設計の刷新（UX変更に必要な最小限のみ）

**完了条件（要点）**
1. フォルダ
   - フォルダ名の変更ができる
   - フォルダ削除ができる（※システムフォルダは除外）
   - フォルダタブを「クリックしてドラッグ」で並び替えでき、並び順が保持される
2. AI編集UX
   - AIボタン押下で「指示入力欄（チャット欄）」がすぐ表示される
   - 入力欄で **Enter** により実行される（**Shift+Enter** で改行）
   - 適用先は次のルールで自動判定される
     - 一部選択: 選択範囲を置換
     - 全文選択: 全文を置換
     - 未選択: カーソル位置に挿入
3. ヘッダー
   - 左端の+（新規メモ作成）を廃止
   - MEMエクスポートボタンをユーザーアイコンの右に配置

---

## 1. 変更したいUX（ユーザー要望）

### 1.1 フォルダ：リネーム/削除/並び替え

- フォルダ名の変更と削除をUIからできるようにする
- フォルダの並び替えは、フォルダタブをクリックしてドラッグで実現する

### 1.2 AI：選択状態に応じた自動適用 + Enter実行

現状:
- AIボタン → 適用先（選択を置換/カーソルに挿入/全文を置換）を選ぶ → 指示入力 → ボタンで実行

変更:
- AIボタン → 指示入力欄のみ表示 → 指示入力 → Enterで実行
- 適用先は「選択状態」から自動判定する

### 1.3 ヘッダー：アイコン整理

- +（新規メモ作成）を廃止
- MEMエクスポートボタンを右端へ移動

---

## 2. 現状構成（関係ファイル）

- `src/content/panelTemplate.ts`: ヘッダーアイコン/AIモーダル等のHTML
- `src/content/content.ts`: クリックイベント/AI実行/選択状態の取得など
- `src/content/panelActions.ts`: フォルダタブ描画、ファイルモーダル描画など
- `src/utils/storage.ts`: `getFolders()`（現在はInbox先頭+名前昇順でソート）
- `src/types/index.ts`: `Folder` / `SyncStorageData` / `MessageType`（フォルダ操作）
- `src/styles/panel.css`: モーダル/タブ/ヘッダーのスタイル

---

## 3. 実装方針（案）

### 3.1 フォルダ並び替え（永続化）

課題:
- 現状の `getFolders()` は「Inbox先頭 + 名前昇順」で並びが固定されるため、並び替えを保持できない

案:
- `chrome.storage.sync` 側にフォルダ順序を保持する配列（例: `folderOrder: string[]`）を追加
- `getFolders()` は `folderOrder` を優先し、足りない分は従来ルールで補完する
  - Inbox（システムフォルダ）は **先頭固定**（並び替え対象外）
- UIはドラッグ操作で配列を並び替え、更新を background へ送って保存する

### 3.2 フォルダのリネーム/削除（UI）

仕様:
- フォルダタブの「フォルダ名を右クリック」からコンテキストメニューを表示し、
  - 名前変更
  - 削除
  を実行できるようにする
- システムフォルダ（Inbox）は、リネーム/削除メニューを出さない（または無効化）
- 削除は確認ダイアログを挟む（配下メモも削除されるため）

### 3.3 AI編集UX（自動判定 + Enter実行）

案:
- `panelTemplate.ts` のAI UIを「指示入力欄中心」に簡素化
  - 適用先 `<select>` は基本的に撤廃（表示しない）
- `content.ts` で selection 状態からモードを決定
  - `selectionStart !== selectionEnd` のとき
    - `selectionStart === 0 && selectionEnd === textarea.value.length` → `replace-all`
    - それ以外 → `replace-selection`
  - `selectionStart === selectionEnd` → `insert-cursor`
- 実行トリガーは入力欄の Enter
  - Shift+Enter は改行

### 3.4 ヘッダー整理

- `panelTemplate.ts` から `new-note-btn` を削除し、関連するイベント処理も整理
- `export-data-btn` を「ユーザーアイコン（auth-btn）の右」へ移動

---

## 4. タスク分解

### Phase 0: 仕様確定（短時間）
- [x] フォルダ並び替えはInboxを除外（先頭固定）
- [x] フォルダのリネーム/削除UIは「フォルダ名を右クリック」
- [x] AI入力欄のEnter挙動（Enter=実行、Shift+Enter=改行）
- [x] エクスポートボタンは「ユーザーアイコンの右」に配置

### Phase 1: フォルダ並び順の保存
- [x] `src/types/index.ts` に並び順保存用の型/MessageTypeを追加
- [x] `src/utils/storage.ts` に並び順の読み書きと `getFolders()` の並び替えロジックを追加
- [x] `src/background/background.ts` に並び替え保存のハンドラを追加

### Phase 2: フォルダタブのドラッグ並び替え（UI）
- [x] `src/content/panelActions.ts` のフォルダタブをドラッグ対応
- [x] ドラッグ中はホバー切替などの副作用を抑止
- [x] 並び替え確定時に保存メッセージを送信し、再描画で反映

### Phase 3: フォルダのリネーム/削除（UI）
- [x] 操作UIを追加（右クリックメニュー/入力UI）
- [x] `RENAME_FOLDER` / `DELETE_FOLDER` を呼び出し、成功時に再描画
- [x] 失敗時のエラー表示（既存の `alert` 方針に合わせる）

### Phase 4: AI編集UXの変更
- [x] `src/content/panelTemplate.ts` のAI UIを簡素化
- [x] `src/content/content.ts` のAIモード自動判定（選択/全文/未選択）を実装
- [x] Enterで実行できるようキーハンドリング追加

### Phase 5: ヘッダー整理
- [x] `new-note-btn` の撤去（UI/イベント）
- [x] `export-data-btn` をユーザーアイコンの右へ移動

### Phase 6: ドキュメント同期
- [x] `docs/requirement/requirement.md` の要件に差分が出る場合は追従
- [ ] `README.md` / `INSTALL.md` に操作方法の差分があれば追従

---

## 5. 手動確認チェックリスト（完了判定）

### フォルダ
- [ ] フォルダの名前変更ができる（Inboxは不可）
- [ ] フォルダ削除ができる（確認あり、Inboxは不可）
- [ ] フォルダタブをドラッグで並び替えでき、再表示しても順序が維持される

### AI
- [ ] AIボタン押下で指示入力欄がすぐ使える
- [ ] 一部選択→置換 / 全文選択→全文置換 / 未選択→カーソル挿入 になる
- [ ] Enterで実行できる（改行も必要ならできる）

### ヘッダー
- [ ] +が消えている
- [ ] エクスポートボタンがユーザーアイコンの右にある
